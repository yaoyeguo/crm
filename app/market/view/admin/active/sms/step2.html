<style>
#goods_page_nav { display:block;padding:5px 0 0 0;}
#prev,#next,.sbtn {cursor:pointer;background:#5D84B0;color:#FFF;border:1px solid #333;padding:2px 5px;margin:0 8px 0 0;}
#no_prev,#no_next{background:#AAA;color:#FFF;border:1px solid #333;padding:2px 5px;margin:0 8px 0 0;display:;}
#tags_list {list-style:none;margin:0;}
    #tags_list li{line-height:2em;background:url(<{$env.app.res_url}>/tags.gif) no-repeat 0 0;padding:0 0 0 25px;border-bottom:1px dotted #CCC;}
</style>

<div id="select_me">

    <!--// todo:非淘宝店铺不支持商品搜索 //-->
    <div class="tabs-wrap finder-tabs-wrap clearfix">
        <ul class="tab_nav">
            <li class="tab current"><span>购买行为</span></li>
            <li class="tab"><span>客户属性</span></li>
            <li class="tab"><span>商品范围</span></li>
            <li class="tab"><span>所属地区</span></li>
            <li class="tab tags_tab"><span>排除客户</span></li>
            <li class="tab"><span>自定义属性</span></li>
            <li class="tab tags_tab"style="display:none;"><span>标签营销</span></li>
        </ul>
    </div>
    
    <div class="tabform" style="display:;">
        <table>
            <tr>
                <th>
                <{help}>所有订单状态包含（下单、已付款、关闭、成功交易、退款）<{/help}>
                <{t}>订单总数 ：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[total_orders][sign]" options=$select_sign value=$filter_mem.filter.total_orders.sign }>
                    
                    <{input type="text" name="filter[total_orders][min_val]" size=10 value=$filter_mem.filter.total_orders.min_val }>
                    
                    <span id="filter[total_orders][sign]" <{if $filter_mem.filter.total_orders.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[total_orders][max_val]" size=10 value=$filter_mem.filter.total_orders.max_val }>
                    </span>
                </td>
               <th>
                <{help}>订单状态为已完成的订单<{/help}>
                <{t}>成功的订单数 ：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[finish_orders][sign]" options=$select_sign value=$filter_mem.filter.finish_orders.sign }>
                    
                    <{input type="text" name="filter[finish_orders][min_val]" size=10 value=$filter_mem.filter.finish_orders.min_val }>
                    
                    <span id="filter[finish_orders][sign]" <{if $filter_mem.filter.finish_orders.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[finish_orders][max_val]" size=10 value=$filter_mem.filter.finish_orders.max_val }>
                    </span>
                </td>
            </tr>
            <tr>
                <th>
                <{help}>所有订单状态包含（下单、已付款、关闭、成功交易、退款)订单的金额<{/help}>
                <{t}>订单总金额 ：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[total_amount][sign]" options=$select_sign value=$filter_mem.filter.total_amount.sign }>
                    
                    <{input type="text" name="filter[total_amount][min_val]" size=10 value=$filter_mem.filter.total_amount.min_val }>
                    
                    <span id="filter[total_amount][sign]" <{if $filter_mem.filter.total_amount.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[total_amount][max_val]" size=10 value=$filter_mem.filter.total_amount.max_val }>
                </td>
                <th>
                <{help}>订单总金额/订单总数 <{/help}>
                <{t}>平均订单价 ：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[total_per_amount][sign]" options=$select_sign value=$filter_mem.filter.total_per_amount.sign }>
                    
                    <{input type="text" name="filter[total_per_amount][min_val]" size=10 value=$filter_mem.filter.total_per_amount.min_val }>
                    
                    <span id="filter[total_per_amount][sign]" <{if $filter_mem.filter.total_per_amount.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[total_per_amount][max_val]" size=10 value=$filter_mem.filter.total_per_amount.max_val }>
                </td>
            </tr>
            <tr>
                <th> 
                <{help}>客户购买的次数含（下单、已付款、关闭、成功交易、退款）的订单，一天多笔订单只算一次<{/help}>
                <{t}>购买频次：<{/t}>
                </th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[buy_freq][sign]" options=$select_sign value=$filter_mem.filter.buy_freq.sign }>
                    
                    <{input type="text" name="filter[buy_freq][min_val]" size=10 value=$filter_mem.filter.buy_freq.min_val }>
                    
                    <span id="filter[buy_freq][sign]" <{if $filter_mem.filter.buy_freq.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[buy_freq][max_val]" size=10 value=$filter_mem.filter.buy_freq.max_val }>
                </td>
                <th> 
                <{help}>时间段内(最后付款的日期 - 第一次付款的日期)/购买频次<{/help}>
                <{t}>平均购买间隔：<{/t}>
                </th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[avg_buy_interval][sign]" options=$select_sign value=$filter_mem.filter.avg_buy_interval.sign }>
                    
                    <{input type="text" name="filter[avg_buy_interval][min_val]" size=10 value=$filter_mem.filter.avg_buy_interval.min_val }>
                    
                    <span id="filter[avg_buy_interval][sign]" <{if $filter_mem.filter.avg_buy_interval.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[avg_buy_interval][max_val]" size=10 value=$filter_mem.filter.avg_buy_interval.max_val }>
                </td>
            </tr>
            <tr>
                <th> 
                <{help}>存在已付款订单的月份数<{/help}>
                <{t}>购买月数：<{/t}>
                </th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[buy_month][sign]" options=$select_sign value=$filter_mem.filter.buy_month.sign }>
                    
                    <{input type="text" name="filter[buy_month][min_val]" size=10 value=$filter_mem.filter.buy_month.min_val }>
                    
                    <span id="filter[buy_month][sign]" <{if $filter_mem.filter.buy_month.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[buy_month][max_val]" size=10 value=$filter_mem.filter.buy_month.max_val }>
                </td>
                <th>
                <{help}>全部订单中出现的商品数量<{/help}>
                <{t}>下单商品总数：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[buy_products][sign]" options=$select_sign value=$filter_mem.filter.buy_products.sign }>
                    
                    <{input type="text" name="filter[buy_products][min_val]" size=10 value=$filter_mem.filter.buy_products.min_val }>
                    
                    <span id="filter[buy_products][sign]" <{if $filter_mem.filter.buy_products.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[buy_products][max_val]" size=10 value=$filter_mem.filter.buy_products.max_val }>
                </td>
            </tr>
            <tr>
                <th>
                <{help}>成功订单的总金额<{/help}>
                <{t}>成功的订单金额：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[finish_total_amount][sign]" options=$select_sign value=$filter_mem.filter.finish_total_amount.sign }>
                    
                    <{input type="text" name="filter[finish_total_amount][min_val]" size=10 value=$filter_mem.filter.finish_total_amount.min_val }>
                    
                    <span id="filter[finish_total_amount][sign]" <{if $filter_mem.filter.finish_total_amount.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[finish_total_amount][max_val]" size=10 value=$filter_mem.filter.finish_total_amount.max_val }>
                </td>
                <th>
                <{help}>成功的平均订单价<{/help}>
                <{t}>成功的平均订单价：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[finish_per_amount][sign]" options=$select_sign value=$filter_mem.filter.finish_per_amount.sign }>
                    
                    <{input type="text" name="filter[finish_per_amount][min_val]" size=10 value=$filter_mem.filter.finish_per_amount.min_val }>
                    
                    <span id="filter[finish_per_amount][sign]" <{if $filter_mem.filter.finish_per_amount.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[finish_per_amount][max_val]" size=10 value=$filter_mem.filter.finish_per_amount.max_val }>
                </td>
            </tr>
            <tr>
                <th>
                <{help}>已创建但未付款的订单<{/help}>
                <{t}>未付款订单数：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[unpay_orders][sign]" options=$select_sign value=$filter_mem.filter.unpay_orders.sign }>
                    
                    <{input type="text" name="filter[unpay_orders][min_val]" size=10 value=$filter_mem.filter.unpay_orders.min_val }>
                    
                    <span id="filter[unpay_orders][sign]" <{if $filter_mem.filter.unpay_orders.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[unpay_orders][max_val]" size=10 value=$filter_mem.filter.unpay_orders.max_val }>
                </td>
                <th>
                <{help}>付款状态为全部退款的订单<{/help}>
                <{t}>退款订单数：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[refund_orders][sign]" options=$select_sign value=$filter_mem.filter.refund_orders.sign }>
                    
                    <{input type="text" name="filter[refund_orders][min_val]" size=10 value=$filter_mem.filter.refund_orders.min_val }>
                    
                    <span id="filter[refund_orders][sign]" <{if $filter_mem.filter.refund_orders.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[refund_orders][max_val]" size=10 value=$filter_mem.filter.refund_orders.max_val }>
                </td>
            </tr>
            <tr>
                <th>
                <{help}>退款总金额<{/help}>
                <{t}>退款总金额：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[refund_amount][sign]" options=$select_sign value=$filter_mem.filter.refund_amount.sign }>
                    
                    <{input type="text" name="filter[refund_amount][min_val]" size=10 value=$filter_mem.filter.refund_amount.min_val }>
                    
                    <span id="filter[refund_amount][sign]" <{if $filter_mem.filter.refund_amount.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[refund_amount][max_val]" size=10 value=$filter_mem.refund_amount.max_val }>
                </td>
               
                <th> <{t}>下单时间：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[create_time][sign]" options=$select_sign_time value=$filter_mem.filter.create_time.sign }>
                    
                    <{input type="date" name="filter[create_time][min_val]" size=10 value=$filter_mem.filter.create_time.min_val }>
                    
                    <span id="filter[create_time][sign]" <{if $filter_mem.filter.create_time.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="date" name="filter[create_time][max_val]" size=10 value=$filter_mem.filter.create_time.max_val }>
                </td>
            </tr>
        </table>
    </div>

    <{assign var="evaluation" value=array('good'=>"好评",'neutral'=>"中评",'bad'=>"差评")}>
    <{assign var="taobaolv" value=array('c'=>'普通客户','asso_vip'=>'荣誉客户','vip1'=>'vip1','vip2'=>'vip2','vip3'=>'vip3','vip4'=>'vip4','vip5'=>'vip5','vip6'=>'vip6')}>
    <div class="tabform" style="display:none">
        <table>
            <tr>
                <th> <{t}>积分范围 ：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[points][sign]" options=$select_sign value=$filter_mem.filter.points.sign }>
                    
                    <{input type="text" name="filter[points][min_val]" size=10 value=$filter_mem.filter.points.min_val }>
                    
                    <span id="filter[points][sign]" <{if $filter_mem.filter.points.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="text" name="filter[points][max_val]" size=10 value=$filter_mem.filter.points.max_val }>
                </td>
            </tr>
            <{**
            <tr>
                <th> <{t}>生日范围 ：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[birthday][sign]" options=$select_sign_time value=$filter_mem.filter.birthday.sign }>
                    
                    <{input type="date" name="filter[birthday][min_val]" size=10 value=$filter_mem.filter.birthday.min_val }>
                    
                    <span id="filter[birthday][sign]" <{if $filter_mem.filter.birthday.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="date" name="filter[birthday][max_val]" size=10 value=$filter_mem.filter.birthday.max_val }>
                </td>
            </tr>
            
            <tr>
                <th> <{t}>客户评价：<{/t}></th>
                <td>
                    <{input type="select" name="filter[shop_evaluation]" options=$evaluation value=$filter_mem.filter.shop_evaluation}>
                </td>
            </tr>
            **}>
            <tr>
                <th> <{t}>客户等级：<{/t}></th>
                <td>
                    <{input type="select" name="filter[lv_id]" options=$levels value=$filter_mem.filter.lv_id}>
                </td>
            </tr>
            <tr style="display:none">
                <th><label>淘宝客户等级：</label></th>
                <td><{input type="select" name="filter[f_level]" options=$taobaolv value=$filter_mem.filter.f_level }></td>
            </tr>
            <tr style="display:none">
                <th> <{t}>VIP客户：<{/t}></th>
                <td>
                    <{input type="bool" name="filter[is_vip]" value=$filter_mem.filter.is_vip}>
                </td>
            </tr>
            <tr style="display:none">
                <th> <{t}>黑名单：<{/t}></th>
                <td>
                    <{input type="bool" name="filter[in_blacklist]" value=$filter_mem.filter.in_blacklist}>
                </td>
            </tr>
            <tr>
            <th> <{t}>第一次下单时间：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[first_buy_time][sign]" options=$select_sign_time value=$filter_mem.filter.first_buy_time.sign }>
                    
                    <{input type="date" name="filter[first_buy_time][min_val]" size=10 value=$filter_mem.filter.first_buy_time.min_val }>
                    
                    <span id="filter[first_buy_time][sign]" <{if $filter_mem.filter.first_buy_time.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="date" name="filter[first_buy_time][max_val]" size=10 value=$filter_mem.filter.first_buy_time.max_val }>
                </td>
            </tr>
            <tr>
                <th> <{t}>最后下单时间：<{/t}></th>
                <td>
                    <{input key="filter_sign" type="select" name="filter[last_buy_time][sign]" options=$select_sign_time value=$filter_mem.filter.last_buy_time.sign }>
                    
                    <{input type="date" name="filter[last_buy_time][min_val]" size=10 value=$filter_mem.filter.last_buy_time.min_val }>
                    
                    <span id="filter[last_buy_time][sign]" <{if $filter_mem.filter.last_buy_time.sign!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="date" name="filter[last_buy_time][max_val]" size=10 value=$filter_mem.filter.last_buy_time.max_val }>
                </td>
            </tr>
        </table>
    </div>

    
    <{input type="hidden" id="filter_goods_id" value=$filter_mem.filter.goods_id}>
    <div class="tabform" style="display:none;">
        <div style="padding:5px 0;">
            商品名称：<input name="filter[good_name]" type="text" class="x-input" id="goods_search_key" value="<{$data.filter.good_name}>" size=8 />

            <{assign var="good_name_sign" value=array('and'=>"和",'or'=>"或")}>
            <{input type="select" id="good_name_sign" name="filter[good_name_sign]" value=$data.filter.good_name_sign options=$good_name_sign }>

            <input name="filter[good_name2]" type="text" class="x-input" id="goods_search_key2" value="<{$data.filter.good_name2}>" size=8 />            

            货号：<input name="filter[good_bn]" type="text" class="x-input" id="good_bn" value="<{$data.filter.good_bn}>" size=8 />

            <{input type="hidden" name="filter[chk_goods_id]" value=1 }>
            <{assign var="chk_goods_id" value=array('1'=>"手动选择",'2'=>"名称匹配")}>
            <span style="display:none;">范围：<{input id="chk_goods_id" type="select" name="filter[chk_goods_id]" value=$data.filter.chk_goods_id options=$chk_goods_id }></span>

            <{**
            <input type="radio" name="findRadio" value="1" checked>模糊
            <input type="radio" name="findRadio" value="2">精确
            **}>
            <button type="button" class="btn" id="btn_search_product"><span><span> 搜 索 </span></span></button>
            <{**
            购买时间：
            <{if $data.filter.good_buy_date && $data.actmemeber == 'yes'}>
            <{input type="select" name="filter[good_buy_date]" value=$data.filter.good_buy_date options=$select_date disabled="disabled"}>
            <input type=hidden name="filter[good_buy_date]" value="<{$data.filter.good_buy_date}>" />
            <{else}>
            <{input type="select" name="filter[good_buy_date]" value=$data.filter.good_buy_date options=$select_date}>
            <{/if}>
            **}>
            <{** 购买数量大于：<{input type="text" name="filter[min_good_num]" value=$data.filter.min_good_num size=4 }> **}>
        </div>
        
        <table class="gridlist">
            <thead>
              <tr>
                <th width='10%'>
                    <input type="checkbox" id="sel_all_goods" />
                </th>
                <th width='10%'>序号</th>
                <th width='20%'><span style="cursor:pointer" id="sort_bn">货号</span></th>
                <th width='50%'><span style="cursor:pointer" id="sort_name">商品名称↑</span></th>
                <th width='10%'>商品价格</th>
              </tr>
            </thead>
            <tbody id="proNode"></tbody>
        </table>
        <span id="goods_page_nav"></span>
        <input type="hidden" id="goods_sort_type" value="name" />
    </div>

    <{input type="hidden" id="filter_regions_id" value=$filter_mem.filter.regions_id}>
    <div class="tabform" style="display:none">
        <p style="background:#FDF8DE;padding:8px;margin:0;">
            <b>地区范围：</b>
            <input type="radio" name="chk_all" id="chk_all1" value="1" />
            <label for="chk_all1">全部地区</label>&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="radio" name="chk_all" id="chk_all2" value="2" />
            <label for="chk_all2">部分地区</label>
        </p>
        <table width="100%" id="tbl_area" >
            <tr>
                <td>
                <table id="region_list" width="100%"  cellpadding=7>
                    <{foreach from=$regions item=v key=k}>
                    <tr>
                        <td width=10%><b><{$k}></b></td>
                        <td width=90%><ul class="region_list">
                        <{foreach from=$v item=vv key=kk}>
                        <li><input name="filter[regions_id][]" id="region<{$kk}>" type="checkbox" value="<{$kk}>" /><label for="region<{$kk}>"><{$vv|substr:0,9}></label></li>
                        <{/foreach}>
                    </ul></td>
                    </tr>
                    <{/foreach}>
                </table>
                </td>
            </tr>
        </table>
    </div>

    <div class="tabform" id="exclude_tabform" style="display:none;height: 270px;">
         <table>
            <tr>
                <td><{input type="checkbox" disabled=“disabled” name="exclude_filter[]" checked="checked" value="1" }></td><td><{t}>黑名单客户组合和重复手机号码，以及无或错误手机号将自动排除<{/t}></td>
            </tr>
            <tr>
                <td><{input type="checkbox" name="exclude_filter[]" value="2" }></td><td><{input type="text" name="exclude_hours" value="72" }><{t}>小时内营销过的客户，不参与本次活动<{/t}></td>
            </tr>
            <tr>
                <td><{input type="checkbox" name="exclude_filter[]" value="3" }><{input type="hidden" name="exclude_tag_id" id="exclude_tag_id" }></td>
                <td onmouseout="hide_tips();">
                <{input type="text" size="50" name="exclude_tag" id="exclude_tag" onkeyup="getDivPositionTag(this)"  }><{t}>的标签组的客户，不参与本次活动<{/t}>
                 <div id="exclude_tag_list" style="display:none;position:absolute; border: #54AAE5 solid 1px;width:290px;background:#fff">
		            <ul style="list-style-type:none; float:left; margin-left:0px; width:100%;" id="input_select_tag">

		            </ul>
		        </div>
                </td>
            </tr>
            <tr>
                <td><{input type="checkbox" name="exclude_filter[]" value="4" }><{input type="hidden" name="exclude_active_id" id="exclude_active_id" }></td>
                <td>
                <{input type="text" size="50" name="exclude_active" id="exclude_active" onkeyup="getDivPositionActive(this)"   }>
                 <div id="exclude_active_list" style="display:none;position:absolute; border: #54AAE5 solid 1px;width:290px;background:#fff">
		            <ul style="list-style-type:none; float:left; margin-left:0px; width:100%;" id="input_select_active">

		            </ul>
		        </div>
                <{t}>参加过此营销活动的客户，不参与本次活动<{/t}>
               </td>
            </tr>
         </table>
    </div>
    <!--自定义属性-->

    <div class="tabform" style="display:none">
        
        <p id='prop_msg' style="padding:30px;color:red;<{if $prop_name }>display:none;<{/if}>">店铺没有设置自定义属性,<a href="index.php?app=ecorder&ctl=admin_shop&act=index" target="_blank">去设置</a></p>
        <ul id="prop_list"<{if(!$prop_name)}>style="display:none;"<{/if}>>
        <{foreach from=$prop_name item=v key=k}>
            <{if $v }>
            <li style="padding:10px 0 0 0;"><{$v}>：
                <{if($prop_type[$k]=='num')}>
                    <{input key="filter_sign" type="select" name="filter[prop_val][{$k}][sign]" options=$select_sign value=$filter_mem.filter[prop_val][$k][sign] }>
                    &nbsp;<{input name="filter[prop_val][{$k}][min_val]" size=10 value=$filter_mem.filter[prop_val][$k][min_val] }>
                    <span id="filter[prop_val][<{$k}>][sign]" <{if $filter_mem.filter[prop_val][$k][sign]!='between'}>style="display:none"<{/if}>> ~ 
                    <{input name="filter[prop_val][{$k}][max_val]" size=10 value=$filter_mem.filter[prop_val][$k][max_val] }>
                    </span>
                    
                <{elseif($prop_type[$k]=='date')}>
                    <{input key="filter_sign" type="select" name="filter[prop_val][{$k}][sign]" options=$select_sign_time value=$filter_mem.filter[prop_val][$k][sign] }>
                    
                    <{input type="date" name="filter[prop_val][{$k}][min_val]" size=10 value=$filter_mem.filter[prop_val][$k][min_val] }>
                    
                    <span id="filter[prop_val][<{$k}>][sign]" <{if $filter_mem.filter[prop_val][$k][sign]!='between'}>style="display:none"<{/if}>> ~ 
                    <{input type="date" name="filter[prop_val][{$k}][max_val]" size=10 value=$filter_mem.filter[prop_val][$k][max_val] }>
                    </span>
                <{else}>
                &nbsp;<{input name="filter[prop_val][{$k}][min_val]" value=$filter_mem.filter[prop_val][$k][min_val] }>
                    
                <{/if}>
                
            </li>
            <{/if}>
        <{/foreach}>
        </ul>

    </div>
    <div class="tabform" style="display:none">
        <table>
            <col width="15%" />
            <col width="85%" />
            <tr><th>已选择标签：</th><td>
                <ul id="tags_list">
                    <{foreach from=$tags_list item=tag key=t_k}>
                        <li><{$tag.tag_name}></li>
                    <{/foreach}>
                </ul>
            </td></tr>
            <tr><th>数据处理方式：</th><td>
            <input type="radio" name="filter[tag_calculation]" value="Intersection" <{if($filter_mem[filter][tag_calculation] == 'intersection') or !$filter_mem[filter][tag_calculation]}>checked="checked"<{/if}>> 交集 &nbsp;&nbsp;&nbsp;&nbsp;      
            <input type="radio" name="filter[tag_calculation]" value="Union"<{if($filter_mem[filter][tag_calculation] == 'and')}>checked="checked"<{/if}>> 并集 
            </td></tr>        
        </table>
        <{input type=hidden name="filter[tags]" id="tags_ids_2" value=$filter_mem[filter][tags]}>
    </div>

    <div id='p_id2'></div>

    <div class="table-action" id="porduct_tag">
        <{button label="<< 上一步" type="button"  id="sel_memup_btn" class="btn-primary"}>
        <{button label="下一步 >>" type="button" id="sel_mem_btn" class="btn-primary"}>
        <{button label="预估" type="button" name="assess_id" class="btn-primary"}>
        <{button label="关闭" type="button" id="member_close_btn" class="nodisabled"}>
    </div>
</div>

<script>
function show_between()
{
    //between运算符处理
    var between_sign = 'between';//介于
    var signs = $('select_me').getElements('select[key=filter_sign]');
    signs.each(function(obj,i){
        obj.addEvent('change',function(){
            if(obj.get('value')==between_sign){
                $(obj.get('name')).setStyle('display','inline');
            }else{
                $(obj.get('name')).setStyle('display','none');
            }
        });
    });
}
(function(){

    $("exclude_tabform").addEvent('click',function(event){
        if(event.target.tagName == 'LI' || event.target.id == 'exclude_tag' || event.target.id == 'exclude_active_id' )
        {
            return;
        }else{
            hide_tips();
       }
    });

    function hide_tips(){
        var tag=document.getElementById("exclude_tag_list");
            tag.style.display = "none";
            var active=document.getElementById("exclude_active_list");
            active.style.display = "none";
    }

    //between运算符处理
    show_between();

    //选项卡效果
    var tab_div = $$('div[class=tabform]');
    var tab_nav = $$('ul[class=tab_nav] li');
    tab_nav.each(function($obj,i){
        $obj.onclick=function(){
            tab_nav.set('class','tab');
            tab_div.setStyle('display', 'none');
            this.set('class','tab current');
            tab_div[i].setStyle('display', 'block');
        };
    });

    <{if($create_source == 'tags')}>
        //如果是从标签创建的
        tab_nav.hide()
        tab_div.hide()
        var tags_nav = $$('.tags_tab');
        tags_nav.show();
        tags_nav[0].set('class','tab current');
        $('exclude_tabform').show();
    <{/if}>
        
    //地区预选中
    var filter_regions_id = ',' + $('filter_regions_id').get('value') + ',';
    var regions_checkbox = $('region_list').getElements('input');
    regions_checkbox.each(function(obj){
        if(filter_regions_id.indexOf(','+obj.value+',')>=0){
            obj.set('checked','checked');
        }
    });

    //全部地区和部分地区的切换
    $('chk_all1').set('checked','checked');
    $('tbl_area').hide();

    $('chk_all2').addEvent('click',function(){
        $('tbl_area').show();
    });
    $('chk_all1').addEvent('click',function(){
        $('tbl_area').hide();
        $$('#tbl_area input[type=checkbox]').set('checked',false);
    });


    // 下一步操作:step3
    $$("#sel_mem_btn").addEvent('click',function(){
        step3();
     });

     $$("#sel_memup_btn").addEvent('click',function(){  //.JSON
        new Request.JSON({
             url : 'index.php?app=market&ctl=admin_active_sms&act=select_member_data&p[0]='+$('active_id_id').value+'&CacheId='+$('CacheId').value+'&CacheIdCreateTime='+$('CacheIdCreateTime').value,
             method : 'post',
             update : $('coupon_id'),
             data:{'uptag':'uptag'},
             onSuccess:function(obj,responseText){
                 var data = JSON.decode(responseText);
                 $('shop_select').value=data.shop_id;
                 $('active_name_id').value = data.active_name;
                 $('active_time_id').value = data.create_time;
                 $('end_time_id').value = data.end_time;
                 $('active_tg_id').value = data.tags;
                 $('cost_id').value = data.cost;
                 $('tags_ids').value = data.filter_mem.filter.tags;
               }
         }).send();
        $('active_id').show();
        $('select_me').hide();
        $('select_sms_template').hide();
        $('btn01').show();
        return true;
    });

})();

    function step3(){
        if($('shop_id').value){
            var shop_id=$('shop_id').value;
        }else {
            var shop_id=$('shop_select').value;
        }

        /*get_total_num();*///预估客户数

        var data = get_filter(); //过滤条件
            data += '&shop_id='+$('shop_id').value;
        new Request({
            url : 'index.php?app=market&ctl=admin_active_sms&act=select_member_data&p[0]='+$('active_id_id').value+'&CacheId='+$('CacheId').value+'&CacheIdCreateTime='+$('CacheIdCreateTime').value+'&create_source='+$('create_source').value,
            method : 'post',
            update : $('coupon_id'),
            data:data,
            onSuccess:function(responseText){
                var data = JSON.decode(responseText);

                if(data.coupon_id){
                    $('only_coupon').value=data.coupon_id;
                    $('coupononlyname').set('html',data.coupon_name);
                }
            }
        }).send();
        $('active_id').hide();
        $('select_me').hide();
        $('select_sms_template').show();
        $('sms_template_id').show();
        //$('coupon_tmp_id').show();
        return true;
    }

    //评估客户数量
    $$("button[name='assess_id']").each(function(ele){
        ele.addEvent('click',function(){get_total_num();});
    });

    function get_total_num(){
    	/*$('p_id2').set('html','正在计算客户数，请稍等。。。');
        $('p_id3').set('html','正在计算客户数，请稍等。。。');
        $('total_num').set('html','正在计算客户数，请稍等。。。');*/
        if($('shop_id').value){
            var shop_id=$('shop_id').value;
        }else{
            var shop_id=$('shop_select').value;
        }

        var data = get_filter();
            data += '&shop_id='+$('shop_id').value;
            data += '&chk_goods_id='+$('chk_goods_id').value;
            data += '&tags_ids='+$$('input[name="filter[tags]"]').value+'&tag_calculation='+$$("input[name='filter[tag_calculation]']:checked").value;
        new Request({
            url : 'index.php?app=market&ctl=admin_active_sms&act=assess&p[0]='+$('active_id_id').value+'&CacheId='+$('CacheId').value+'&CacheIdCreateTime='+$('CacheIdCreateTime').value,
            method : 'post',
            //update : $('p_id'),
            data:data,
            onSuccess : function(responseText) {
                if($('control_group').value == 'yes'){
                    var active_members = parseInt(responseText/2);
                    if(responseText/2 != active_members) active_members++;
                    var compare_members = responseText - active_members;
                    responseText = '您选择的客户数：' + active_members + '；对照客户数：' + compare_members;
                }else{
                    responseText = '您选择的客户数：' + responseText;
                }
                $('p_id2').set('html',responseText);
                /*$('p_id3').set('html',responseText);
                $('total_num').set('html',responseText);*/
            }
        }).send();

        //$('active_id').hide();
        //$('select_me').show();
        //$('select_sms_template').hide();
        return true;
    }

    //获取页面内的搜索条件
    function get_filter(){
        var iname;
        var itype;
        var str='1';
        $$('#select_me input').each(function(ele,i){
            //alert(i);
            iname = ele.get('name');
            itype = ele.get('type');
            if(iname && (iname.indexOf('filter')>=0 || iname.indexOf('exclude')>=0) ){
                if((itype!='checkbox' && itype!='radio') || ele.checked==true){
                    str += '&'+iname+'='+ele.value;
                }
            }
        });
        $$('#select_me select').each(function(ele,i){
            //alert(i);
            iname = ele.get('name');
            if(iname && iname.indexOf('filter')>=0){
                str += '&'+iname+'='+ele.value;
            }
        });
        return str;
    }

    function getDivPositionTag(o)
    {
        var keyword = $(o).value;
        if(keyword == '')
            return;
        var _url="index.php?app=market&ctl=admin_active_sms&act=ajax_get_tag&keyword=" + encodeURI(keyword);
        new Request({
            url : _url,
            method : 'get',
            onSuccess : function(responseText){
                    var data = JSON.decode(responseText);
                    var data_l = data.length;
                    if(data_l > 0)
                    {
                        var str = '';
                        for(var i=0;i<data_l;i++)
                        {
                            str += '<li onmousemove="this.style.backgroundColor=\'#54AAE5\'" onmouseout="this.style.backgroundColor=\'#fff\'" style="cursor:pointer" tag_id="' + data[i].tag_id + '" onclick="setDivHiddenTempTag(this);">' + data[i].tag_name + '</li>';
                        }
                        $('input_select_tag').set('html',str);
                    }else{
                        $('input_select_tag').set('html','<li onmousemove="this.style.backgroundColor=\'#54AAE5\'" onmouseout="this.style.backgroundColor=\'#fff\'">未找到对应信息</li>');
                    }
            }
        }).send();

        $('exclude_tag_list').show();
    }

    function setDivHiddenTempTag(t)
    {
    	$('exclude_tag_id').value = $(t).get('tag_id');
        $('exclude_tag').value = $(t).get('text');
        $('exclude_tag_list').hide();
    }

    function getDivPositionActive(o)
    {
        var keyword = $(o).value;
        if(keyword == '')
            return;
        var _url="index.php?app=market&ctl=admin_active_sms&act=ajax_get_active&shop_id="+ $('shop_id').value +"&keyword=" + encodeURI(keyword);
        new Request({
            url : _url,
            method : 'get',
            onSuccess : function(responseText){
                    var data = JSON.decode(responseText);
                    var data_l = data.length;
                    if(data_l > 0)
                    {
                        var str = '';
                        for(var i=0;i<data_l;i++)
                        {
                            str += '<li onmousemove="this.style.backgroundColor=\'#54AAE5\'" onmouseout="this.style.backgroundColor=\'#fff\'" style="cursor:pointer" active_id="' + data[i].active_id + '" onclick="setDivHiddenTempActive(this);">' + data[i].active_name + '</li>';
                        }
                        $('input_select_active').set('html',str);
                    }else{
                        $('input_select_active').set('html','<li onmousemove="this.style.backgroundColor=\'#54AAE5\'" onmouseout="this.style.backgroundColor=\'#fff\'">未找到对应信息</li>');
                    }
            }
        }).send();

        $('exclude_active_list').show();
    }

    function setDivHiddenTempActive(t)
    {
    	$('exclude_active_id').value = $(t).get('active_id');
        $('exclude_active').value = $(t).get('text');
        $('exclude_active_list').hide();
    }


//商品搜索
    //商品全选
    $('sel_all_goods').addEvent('click',function(){
        if(this.checked == true){
            $$('#proNode input[name="filter[goods_id][]"]').set('checked','checked');
        }else{
            $$('#proNode input[name="filter[goods_id][]"]').set('checked','');
        }
        set_good_bgcolor();
    });
    
    //搜索商品
    $('btn_search_product').addEvent('click',function(){
        var findRadioValue = $$('input[name="findRadio"]:checked').get('value');
        var goodsSearchKey = $('goods_search_key').get('value');
        if (2 > goodsSearchKey.length && goodsSearchKey.length != 0) {
            alert('商品名称至少是2个字符以上');
            return false;
        }
        page = 0;
        gotoPage(0);
    });
    
    //搜索商品
    var page = 0;
    var goods_page_nav = '';
    goods_page_nav += '<span id="page_no" style="float:right">第 1 页</span>';
    goods_page_nav += '<span id="no_prev">上一页</span>';
    goods_page_nav += '<span id="prev" onclick="gotoPage(-1)">上一页</span>';
    goods_page_nav += '<span id="next" onclick="gotoPage(1)">下一页</span>';
    goods_page_nav += '<span id="no_next">下一页</span>';
    goods_page_nav += '<span class="sbtn" onclick="check_all_goods(1);">全选</span>';
    goods_page_nav += '<span class="sbtn" onclick="check_all_goods(0);">清空</span>';
    $('goods_page_nav').set('html',goods_page_nav);
    $('prev').hide();$('no_prev').show();
    
    //商品预选中
    var page = 0;
    var filter_goods_id = $('filter_goods_id').get('value');
    //非当前步骤不加载数据
    if(curr_step == 'sel_member'){
    if(filter_goods_id) {
        filter_goods_id = ',' + filter_goods_id + ',';
        getProducts(filter_goods_id);//预先加载商品列表
        }else{
            setTimeout('gotoPage(0)', 1000);
        }
    } 
    
    $('sort_bn').addEvent('click', function(){
        $('sort_bn').set('text', '货号↑');
        $('sort_name').set('text', '商品名称');
        $('goods_sort_type').set('value','bn');
        gotoPage(0);
    });
    
    $('sort_name').addEvent('click', function(){
        $('sort_bn').set('text', '货号');
        $('sort_name').set('text', '商品名称↑');
        $('goods_sort_type').set('value','name');
        gotoPage(0);
    });
    
    function check_all_goods(flag){
    if(flag==1){
        $$('#proNode input[name="filter[goods_id][]"]').set('checked','checked');
    }else{
        $$('#proNode input[name="filter[goods_id][]"]').set('checked','');
    }
    set_good_bgcolor();
}

function gotoPage(p){
    if(p==0) page=0;
    page += p;
    $('next').show();
    $('no_next').hide();
    if(page<=0) {
        $('prev').hide();
        $('no_prev').show();
    }else{
        $('prev').show();
        $('no_prev').hide();
    }
    getProducts();
    $('page_no').set('html','第 '+(page+1)+' 页');
}

function getProducts(filter_goods_id){

    $('no_next').hide();
    
    var sel_goods = '0';
    var goods_sort_type = $('goods_sort_type').get('value');
    var good_name_sign = $('good_name_sign').get('value');
    var goods_search_key = $('goods_search_key').get('value');
    var goods_search_key2 = $('goods_search_key2').get('value');
    var good_bn = $('good_bn').value;
    var shop_id = $('shop_id').get('value');
    var new_node = '';
    var proNode = $('proNode');
    var chkBox = proNode.getElements('input');
    var template_active = '\
                        <td><input type="checkbox" name="filter[goods_id][]" value="{$goods_id}" /></td>\
                        <td name="goods_no"></td>\
                        <td>{$bn}</td>\
                        <td style="text-align:left;">{$name}</td>\
                        <td>{$price}</td>\
                    ';
                    
    var template_disabled = '\
                        <td bgcolor="#eeeeee"><input checked type="checkbox" disabled /></td>\
                        <td bgcolor="#eeeeee" name="goods_no"></td>\
                        <td bgcolor="#eeeeee">{$bn}</td>\
                        <td bgcolor="#eeeeee" style="text-align:left;">{$name}</td>\
                        <td bgcolor="#eeeeee">{$price}</td>\
                    ';
    var templates = '';
    
    //只移除未选择的商品
    chkBox.each(function($obj,i){
        var tr_obj = $obj.parentNode.parentNode;
        //alert(tr_obj.getStyle('backgroundColor'))
        if(tr_obj.getStyle('backgroundColor') != '#ffffcc') {
            tr_obj.remove();
        }else{
            sel_goods += ','+$obj.value;
        }
    });
    
    if(filter_goods_id) {
        page = 0;
    }
    
    var data_str = 'shop_id='+shop_id+'&page='+page+'&sel_goods='+sel_goods+'&sort_type='+goods_sort_type;
    if(filter_goods_id) {
        data_str += '&filter_goods_id='+filter_goods_id;
    }else{
        data_str += '&name='+goods_search_key+'&name2='+goods_search_key2+'&sign='+good_name_sign+'&bn='+good_bn;
    }
    var ajaxReq = new Request(
    {
        method : 'post',
        url : 'index.php?app=ecorder&ctl=admin_goods&act=ajaxGet',
        data: data_str,
        onSuccess : function(responseText) {
            //alert(responseText);
            var total_page = 0;
            if(responseText != 'null') {
                var obj = eval('(' + responseText + ')');
                
                //设置页码
                var total = obj[obj.length-1];
                if(total > 0){
                    total_page = Math.ceil(total/10);
                    $('page_no').set('html','第 '+(page+1)+'/'+total_page+' 页');
                }
                
                for(var i=0;i<obj.length-1;i++){
                
                    if((sel_goods+',').indexOf(','+obj[i].goods_id+',')== -1){
                        templates = template_active;
                    }else{
                        templates = template_disabled;
                    }
                
                    //关键词描红
                    obj[i].name = obj[i].name.replace(goods_search_key,'<font color=red>'+goods_search_key+'</font>');
                    
                    if(goods_search_key2){
                        obj[i].name = obj[i].name.replace(goods_search_key2,'<font color=blue>'+goods_search_key2+'</font>');
                    }
                
                    new_node = templates.replace('{$bn}',obj[i].bn).replace('{$name}',obj[i].name).replace('{$price}',obj[i].price).replace('{$goods_id}',obj[i].goods_id);
                    var new_tr = new Element('tr');
                    new_tr.set('html',new_node);
                    new_tr.inject(proNode);
                }
                
                //首次加载时，预先选中上次商品
                if(filter_goods_id) {
                    var goods_checkbox = $('proNode').getElements('input');
                    goods_checkbox.each(function(obj){
                        if(filter_goods_id.indexOf(','+obj.value+',')>=0){
                            obj.set('checked','checked');
                        }
                    });
                }
                
                if((page+1)>=total_page) {
                    $('next').hide();
                    $('no_next').show();
                }
                
                $$('#proNode input[name="filter[goods_id][]"]').addEvent('click',function(){
                    set_good_bgcolor();
                });
                
                set_good_bgcolor();
                
            }else{
                $('next').hide();
                $('no_next').show();
            }
        },
        onFailure : function() {}
    });
    ajaxReq.send();
}

function set_good_bgcolor(){
    $$('#proNode input[name="filter[goods_id][]"]').each(function(ele){
        var pe = (ele.parentNode.parentNode);
        if(ele.checked == true){
            pe.style.backgroundColor = '#FFFFCC';
        }else{
            pe.style.backgroundColor = '';
        }
    });
    
    $$('#proNode td[name="goods_no"]').each(function(ele,idx){
        ele.set('text', (idx+1));
    });
}
</script>
